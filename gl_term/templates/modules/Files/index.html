{# Compute current_path inside template if not provided by server #}
{% set current_path = request.args.get('file') or ("C:/" if sys.platform.startswith("win") else "/") %}

{# volumes and items still come from your existing helpers #}
{% set vols = get_volumes() %}
{% set items = list_dir_safe(current_path) %}

<div style="display:flex; height:100vh; font-family:JetBrainsMono; color:white; background:#0a0f1d;">

  <!-- Sidebar (unchanged) -->
  <aside style="width:180px; background:#1f1f1f; display:flex; flex-direction:column; overflow-y:auto; flex-shrink:0;">
    {% for v in vols %}
      {% set ok = check_path(v.path) is sameas true %}
      <a href="javascript:void(0)"
         style="display:block; padding:12px; color:{{ 'white' if ok else '#888' }}; text-decoration:none; border-radius:4px; margin:2px 0;"
         {% if ok %}
           onclick="ChangeContentMain('Files','/index?file={{ v.path | urlencode }}')"
         {% endif %}
         onmouseover="if({{ 'true' if ok else 'false' }}) this.style.background='#3d7be3';" onmouseout="this.style.background='';">
        <i class="fa fa-hdd-o" style="margin-right:6px;"></i>{{ v.path }}
        {% if not ok %}<span style="font-size:12px; color:#ff6666; margin-left:4px;">(Not Ready)</span>{% endif %}
      </a>
    {% endfor %}
  </aside>

  <!-- Main -->
  <main style="flex:1; overflow:auto; min-width:0; padding:12px;">

    <h3 style="font-size:16px; font-weight:bold; margin-bottom:6px;">Current Path: {{ current_path }}</h3>

    {# Use server-side helper to build breadcrumbs #}
    {% set crumbs = build_breadcrumbs(current_path) %}
    <div style="display:flex; flex-wrap:wrap; align-items:center; margin-bottom:12px; font-size:14px;">
      {% for label, url in crumbs %}
        <a href="javascript:void(0)"
           style="color:#58a6ff; text-decoration:none; padding:2px 6px; border-radius:4px; margin-right:4px;"
           onclick="ChangeContentMain('Files','/index?file={{ url | urlencode }}')">{{ label }}</a>
        {% if not loop.last %}<span style="margin-right:4px; color:#aaa;">/</span>{% endif %}
      {% endfor %}
    </div>

    {# Upload and items logic unchanged #}
    <form method="post" action="/upload" enctype="multipart/form-data" style="margin-bottom:12px;">
      <input type="hidden" name="path" value="{{ current_path }}">
      <input type="file" name="file" multiple style="display:block; margin-bottom:6px; padding:6px; width:100%; background:#222; color:white; border:1px solid #58a6ff; border-radius:4px;">
      <button type="submit" style="padding:6px 12px; background:#3d7be3; color:white; border-radius:4px; border:none; cursor:pointer;">Upload</button>
    </form>

    {% if items is string %}
      <p style="color:red;">{{ items }}</p>
    {% else %}
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; color:white; font-size:14px;">
          <thead style="background:#121826;">
            <tr>
              <th style="padding:4px; text-align:left; border-bottom:1px solid #1f2937;">Name</th>
              <th style="padding:4px; text-align:left; border-bottom:1px solid #1f2937;">Size</th>
              <th style="padding:4px; text-align:left; border-bottom:1px solid #1f2937;">Last Modified</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              {% set status = check_path(item.path) %}
              <tr style="border-bottom:1px solid #1f2937;">
                <td>
                  {% if item.is_dir %}
                    <a href="javascript:void(0)" style="display:flex; align-items:center; padding:4px; border-radius:4px; text-decoration:none; color:{{ 'white' if status is sameas true else '#888' }};"
                       {% if status is sameas true %} onclick="ChangeContentMain('Files','/index?file={{ item.path | urlencode }}')" {% endif %}>
                      <i class="fa fa-folder" style="margin-right:4px;"></i>{{ item.name }}
                      {% if status is not sameas true %}<span style="font-size:12px; color:#ff6666; margin-left:4px;">({{ status }})</span>{% endif %}
                    </a>
                  {% else %}
                    <a href="javascript:void(0)" style="display:flex; align-items:center; padding:4px; border-radius:4px; text-decoration:none; color:{{ 'white' if status is sameas true else '#888' }};"
                       {% if status is sameas true %} onclick="ChangeContentMain('Files','/filepreview?file={{ item.path | urlencode }}')" {% endif %}>
                      <i class="fa fa-file" style="margin-right:4px;"></i>{{ item.name }}
                      {% if status is not sameas true %}<span style="font-size:12px; color:#ff6666; margin-left:4px;">({{ status }})</span>{% endif %}
                    </a>
                  {% endif %}
                </td>
                <td>{{ item.size if item.is_file else '-' }}</td>
                <td>{{ item.mtime|int }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </main>
</div>
